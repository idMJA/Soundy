<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Soundy Native WebSocket Test</title>
    <style>
        body { font-family: sans-serif; background: #f5f5f5; max-width: 600px; margin: 40px auto; }
        .log { background: #222; color: #eee; padding: 10px; border-radius: 4px; min-height: 120px; margin-top: 10px; }
        input, button { padding: 8px; margin: 4px; }
    </style>
</head>
<body>
    <h2>Soundy Native WebSocket Test (Elysia)</h2>
    <div>
        <input id="guildId" placeholder="Guild ID (optional)" />
        <input id="userId" placeholder="User ID (for user-centric)" />
        <button onclick="connectWS()">Connect</button>
        <button onclick="disconnectWS()">Disconnect</button>
    </div>
    <div>
        <input id="msg" placeholder="Send message (optional)" />
        <button onclick="sendMsg()">Send</button>
    </div>
    <div>
        <button onclick="pausePlayer()">Pause</button>
        <button onclick="resumePlayer()">Resume</button>
        <button onclick="skipTrack()">Skip</button>
        <button onclick="stopPlayer()">Stop</button>
    </div>
    <div>
        <input id="query" placeholder="Link atau keyword" />
        <input id="voiceChannelId" placeholder="Voice Channel ID (optional)" />
        <button onclick="playTrack()">Play</button>
        <button onclick="getQueue()">Queue</button>
    </div>
    <div>
        <label for="volume">Volume:</label>
        <input id="volume" type="range" min="0" max="100" value="50" style="width:200px;" oninput="updateVolumeLabel(this.value)" />
        <span id="volumeLabel">50</span>
        <button onclick="setVolume()">Set Volume</button>
        <button onclick="getVolume()">Get Volume</button>
    </div>
    <div style="margin-top:24px;">
        <b>Now Playing</b>
        <div id="nowPlaying">-</div>
        <b style="margin-top:12px;display:block;">Queue</b>
        <div id="queue">-</div>
    </div>
    <div class="log" id="log">Log:<br></div>
    <script>
        let ws = null;
        let userContext = {};
        function log(msg) {
            document.getElementById('log').innerHTML += msg + '<br>';
        }
        let lastNowPlaying = null;
        let nowPlayingInterval = null;
        function updateNowPlaying(track) {
            const el = document.getElementById('nowPlaying');
            if (!track) {
                el.innerHTML = '-';
                lastNowPlaying = null;
                clearInterval(nowPlayingInterval);
                nowPlayingInterval = null;
                return;
            }
            lastNowPlaying = track;
            renderNowPlaying(track);
            if (!nowPlayingInterval) {
                nowPlayingInterval = setInterval(() => {
                    if (lastNowPlaying && typeof lastNowPlaying.position === 'number' && !lastNowPlaying.paused && lastNowPlaying.duration) {
                        lastNowPlaying.position += 1000;
                        renderNowPlaying(lastNowPlaying);
                    }
                }, 1000);
            }
        }
        function renderNowPlaying(track) {
            const el = document.getElementById('nowPlaying');
            let html = `<b>${track.title}</b> by ${track.author} <span style='color:#888;'>[${msToTime(track.duration)}]</span>`;
            if (typeof track.position === 'number' && track.duration) {
                html += `<br><progress value="${track.position}" max="${track.duration}" style="width:200px;"></progress> <span style='color:#888;'>${msToTime(track.position)} / ${msToTime(track.duration)}</span>`;
            }
            if (track.uri) {
                html += `<br><a href="${track.uri}" target="_blank">Link</a>`;
            }
            html += `<pre style='background:#eee;color:#222;padding:4px;border-radius:4px;margin-top:8px;font-size:12px;'>${JSON.stringify(track, null, 2)}</pre>`;
            el.innerHTML = html;
        }
        function updateQueue(queue) {
            const el = document.getElementById('queue');
            if (!queue || !queue.length) {
                el.innerHTML = '-';
                return;
            }
            el.innerHTML = queue.map((track, i) =>
                `${i + 1}. <b>${track.title}</b> by ${track.author} <span style='color:#888;'>[${msToTime(track.duration)}]</span>`
            ).join('<br>');
        }
        function msToTime(ms) {
            let s = Math.floor(ms / 1000);
            let m = Math.floor(s / 60);
            s = s % 60;
            let h = Math.floor(m / 60);
            m = m % 60;
            return (h > 0 ? h + ':' : '') + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
        }
        function connectWS() {
            const guildId = document.getElementById('guildId').value;
            const userId = document.getElementById('userId').value;
            ws = new WebSocket('ws://localhost:4000/ws');
            ws.onopen = () => {
                log('Connected!');
                userContext = {};
                if (userId) {
                    ws.send(JSON.stringify({ type: 'user-connect', userId }));
                    log('Sent user-connect for userId: ' + userId);
                } else if (guildId) {
                    ws.send(JSON.stringify({ type: 'join', guildId }));
                }
            };
            ws.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    if (data.type === 'user-connect' && data.success) {
                        userContext.guildId = data.guildId;
                        userContext.voiceChannelId = data.voiceChannelId;
                        userContext.userId = data.userId;
                        log('User context set: ' + JSON.stringify(userContext));
                    } else if (data.type === 'user-connect' && !data.success) {
                        log('User not found in any voice channel with active player.');
                    } else if (data.type === 'queue') {
                        log('Queue:');
                        updateQueue(data.queue);
                        if (data.queue && data.queue.length) {
                            data.queue.forEach((track, i) => {
                                log(`${i + 1}. ${track.title} (${track.author}) [${track.duration}ms]`);
                            });
                        } else {
                            log('Queue kosong');
                        }
                    } else if (data.type === 'user-status') {
                        if (data.found === false) {
                            log('User tidak ditemukan di voice channel manapun.');
                            updateNowPlaying(null);
                            updateQueue([]);
                        } else {
                            log(`User ditemukan di guild: ${data.guildId}, channel: ${data.voiceChannelId}`);
                            log('Player state: ' + JSON.stringify(data.player, null, 2));
                            if (data.player) {
                                updateNowPlaying(data.player.current);
                                updateQueue(data.player.queue);
                            }
                        }
                    } else if (data.type === 'status' && typeof data.volume === 'number') {
                        log('Status data: ' + JSON.stringify(data));
                        document.getElementById('volume').value = data.volume;
                        updateVolumeLabel(data.volume);
                        log('Current volume: ' + data.volume);
                        updateNowPlaying(data.current);
                        updateQueue(data.queue);
                    } else if (data.type === 'volume' && typeof data.volume === 'number') {
                        document.getElementById('volume').value = data.volume;
                        updateVolumeLabel(data.volume);
                        log('Volume set to: ' + data.volume);
                    } else if (data.type === 'trackStart' && data.current) {
                        updateNowPlaying(data.current);
                    } else if (data.type === 'trackEnd') {
                        updateNowPlaying(null);
                    } else if (data.type === 'queueEnd') {
                        updateQueue([]);
                    } else if (data.type === 'play' && data.success) {
                        // Jika ada track/playlist yang berhasil ditambahkan, update queue
                        if (data.track) {
                            log('Track ditambahkan: ' + data.track.title);
                        }
                        // Request queue terbaru
                        getQueue();
                    } else {
                        log('Received: ' + e.data);
                    }
                } catch {
                    log('Received: ' + e.data);
                }
            };
            ws.onclose = () => log('Disconnected!');
            ws.onerror = (e) => log('WebSocket error!');
        }
        function disconnectWS() {
            if (ws) ws.close();
            userContext = {};
        }
        function sendMsg() {
            if (ws && ws.readyState === 1) {
                ws.send(document.getElementById('msg').value);
            }
        }
        function pausePlayer() {
            const guildId = userContext.guildId || document.getElementById('guildId').value;
            const userId = userContext.userId || document.getElementById('userId').value;
            if (ws && ws.readyState === 1 && guildId) {
                ws.send(JSON.stringify({ type: 'pause', guildId, userId }));
                log('Sent pause request');
            }
        }
        function resumePlayer() {
            const guildId = userContext.guildId || document.getElementById('guildId').value;
            const userId = userContext.userId || document.getElementById('userId').value;
            if (ws && ws.readyState === 1 && guildId) {
                ws.send(JSON.stringify({ type: 'resume', guildId, userId }));
                log('Sent resume request');
            }
        }
        function playTrack() {
            const query = document.getElementById('query').value;
            const guildId = userContext.guildId || document.getElementById('guildId').value;
            const voiceChannelId = userContext.voiceChannelId || document.getElementById('voiceChannelId').value;
            const userId = userContext.userId || document.getElementById('userId').value;
            if (ws && ws.readyState === 1 && guildId && query && voiceChannelId) {
                ws.send(JSON.stringify({ type: 'play', guildId, query, voiceChannelId, userId }));
                log('Sent play request: ' + query);
            }
        }
        function getQueue() {
            const guildId = userContext.guildId || document.getElementById('guildId').value;
            const userId = userContext.userId || document.getElementById('userId').value;
            if (ws && ws.readyState === 1 && guildId) {
                ws.send(JSON.stringify({ type: 'queue', guildId, userId }));
                log('Requested queue');
            }
        }
        function skipTrack() {
            const guildId = userContext.guildId || document.getElementById('guildId').value;
            const userId = userContext.userId || document.getElementById('userId').value;
            if (ws && ws.readyState === 1 && guildId) {
                ws.send(JSON.stringify({ type: 'skip', guildId, userId }));
                log('Sent skip request');
            }
        }
        function stopPlayer() {
            const guildId = userContext.guildId || document.getElementById('guildId').value;
            const userId = userContext.userId || document.getElementById('userId').value;
            if (ws && ws.readyState === 1 && guildId) {
                ws.send(JSON.stringify({ type: 'stop', guildId, userId }));
                log('Sent stop request');
            }
        }
        function updateVolumeLabel(val) {
            document.getElementById('volumeLabel').textContent = val;
        }
        function setVolume() {
            const guildId = userContext.guildId || document.getElementById('guildId').value;
            const userId = userContext.userId || document.getElementById('userId').value;
            const volume = parseInt(document.getElementById('volume').value, 10);
            if (ws && ws.readyState === 1 && guildId && !isNaN(volume)) {
                ws.send(JSON.stringify({ type: 'volume', guildId, volume, userId }));
                log('Sent volume request: ' + volume);
            }
        }
        function getVolume() {
            const guildId = userContext.guildId || document.getElementById('guildId').value;
            if (ws && ws.readyState === 1 && guildId) {
                ws.send(JSON.stringify({ type: 'status', guildId }));
                log('Requested current volume');
            }
        }
    </script>
</body>
</html>
